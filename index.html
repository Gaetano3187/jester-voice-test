<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Jester ‚Äì Modulo Vocale (Demo)</title>
  <style>
    :root {
      --green: #4CAF50;
      --red:   #e53935;
      --light: #f4f4f4;
      --white: #fff;
      --gray:  #ddd;
      --shadow: rgba(0,0,0,0.1);
    }
    * { box-sizing: border-box; }
    body {
      font-family: 'Segoe UI', sans-serif;
      margin: 0;
      background: var(--light);
      color: #333;
    }
    header {
      background: var(--green);
      color: #fff;
      padding: 1rem 1.5rem;
      display: flex;
      align-items: center;
      justify-content: space-between;
    }
    header h1 {
      font-size: 1.2rem;
      margin: 0;
    }
    header button {
      background: none;
      border: none;
      color: #fff;
      font-size: 1.6rem;
      cursor: pointer;
    }
    main {
      padding: 1rem;
      max-width: 800px;
      margin: auto;
    }
    .card {
      background: var(--white);
      border-radius: 10px;
      box-shadow: 0 0 10px var(--shadow);
      padding: 1rem;
      margin: 1rem 0;
    }
    /* Banner di conferma (inizialmente nascosto) */
    #confirmBanner {
      position: fixed;
      bottom: 20px;
      left: 50%;
      transform: translateX(-50%);
      background: var(--white);
      border: 1px solid var(--gray);
      box-shadow: 0 0 5px var(--shadow);
      padding: 1rem 1.5rem;
      border-radius: 8px;
      display: none;
      z-index: 1000;
    }
    #confirmBanner p {
      margin: 0 0 0.5rem 0;
    }
    #confirmBanner button {
      margin-right: 0.5rem;
      padding: 0.5rem 0.8rem;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      font-size: 0.9rem;
    }
    #confirmYes {
      background: var(--green);
      color: #fff;
    }
    #confirmNo {
      background: var(--red);
      color: #fff;
    }
    /* Lista fittizia di ‚ÄúSupermercato‚Äù */
    #lista-supermercato {
      list-style: none;
      padding: 0;
      margin: 0.5rem 0 0;
    }
    #lista-supermercato li {
      padding: 0.5rem;
      border-bottom: 1px solid var(--gray);
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    #lista-supermercato li:last-child {
      border-bottom: none;
    }
    #lista-supermercato .remove-btn {
      background: transparent;
      border: none;
      color: var(--red);
      font-size: 1rem;
      cursor: pointer;
    }
    /* Stato microfono */
    #voiceStatus {
      font-size: 0.9rem;
    }
    /* Toast di conferma */
#toast {
  position: fixed;
  left: 50%;
  bottom: 1.5rem;
  transform: translateX(-50%);
  background: #4CAF50;
  color: #fff;
  padding: 0.75rem 1.5rem;
  border-radius: 30px;
  box-shadow: 0 4px 12px rgba(0,0,0,0.15);
  font-size: 0.95rem;
  opacity: 0;
  pointer-events: none;
  transition: opacity 0.3s ease;
  z-index: 9999;
}
#toast.show {
  opacity: 1;
  animation: fadeOut 2s 1s forwards;
}
@keyframes fadeOut {
  to { opacity: 0; }
}

  </style>
</head>
<body>
  <header>
    <h1>üé§ Jester (Demo Vocale)</h1>
    <button id="voiceToggle">üéôÔ∏è</button>
  </header>

  <main>
    <!-- Sezione di riepilogo lista Supermercato (fittizia) -->
    <section class="card">
      <h2>üõí Lista Supermercato</h2>
      <ul id="lista-supermercato">
        <li>(vuota)</li>
      </ul>
    </section>

    <!-- Status microfono e messaggi di debug -->
    <section class="card">
      <h2>üì¢ Stato Microfono & Comandi</h2>
      <p id="voiceStatus">Microfono inattivo</p>
      <p id="debugText"></p>
    </section>
  </main>

  <!-- Banner di conferma per Aggiungi/Rimuovi -->
  <div id="confirmBanner">
    <p id="confirmMessage">[Messaggio di conferma]</p>
    <button id="confirmYes">S√¨</button>
    <button id="confirmNo">No</button>
  </div>

  <!-- Script JavaScript -->
<!-- Toast di conferma -->
<div id="toast"></div>

    // Mostra un messaggio di conferma animato
  function showToast(msg = "Operazione completata!") {
    const toast = document.getElementById("toast");
    toast.textContent = msg;
    toast.classList.add("show");
    setTimeout(() => toast.classList.remove("show"), 3000);
  }

  </script><    // Verifichiamo il supporto al Web Speech API
    window.SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition || null;
    if (!window.SpeechRecognition) {
      document.getElementById('voiceStatus').innerText = "Il tuo browser non supporta il riconoscimento vocale.";
    }

    // Stato globale
    let recognizing = false;
    let currentIntent = null;   // { type: "Aggiungi"|"Rimuovi", prodotto: string, quantita: number, unita: string, lista: "supermercato"|"online" }
    let recognition;            // oggetto SpeechRecognition

    // Riferimenti a elementi DOM
    const voiceToggle    = document.getElementById('voiceToggle');
    const voiceStatus    = document.getElementById('voiceStatus');
    const debugText      = document.getElementById('debugText');
    const confirmBanner  = document.getElementById('confirmBanner');
    const confirmMessage = document.getElementById('confirmMessage');
    const confirmYes     = document.getElementById('confirmYes');
    const confirmNo      = document.getElementById('confirmNo');
    const listaSuper     = document.getElementById('lista-supermercato');

    // Inizializzazione di SpeechRecognition
    if (window.SpeechRecognition) {
      recognition = new window.SpeechRecognition();
      recognition.lang = 'it-IT';
      recognition.interimResults = false;
      recognition.maxAlternatives = 1;

      recognition.addEventListener('start', () => {
        recognizing = true;
        voiceStatus.innerText = "üéß Ascoltando...";
        debugText.innerText = "";
      });

      recognition.addEventListener('end', () => {
        recognizing = false;
        voiceStatus.innerText = "Microfono inattivo";
      });

      recognition.addEventListener('error', (e) => {
        recognizing = false;
        voiceStatus.innerText = "Errore di riconoscimento: " + e.error;
      });

      recognition.addEventListener('result', (event) => {
        const transcript = event.results[0][0].transcript.trim();
        debugText.innerText = `‚û°Ô∏è Hai detto: "${transcript}"`;
        parseIntent(transcript.toLowerCase());
      });
    }

    // Avvia/ferma il riconoscimento quando si clicca il pulsante üéôÔ∏è
    voiceToggle.addEventListener('click', () => {
      if (!window.SpeechRecognition) return;

      if (recognizing) {
        recognition.stop();
        return;
      }
      recognition.start();
    });

    // Funzione di parsing intent (molto basica, con regex)
    function parseIntent(text) {
      // Reset dell‚Äôintent corrente
      currentIntent = null;

      // Pattern ‚ÄúAggiungi [quantit√†] [unit√†]? [prodotto] alla lista del (supermercato|online)‚Äù
      const aggiungiPattern = /aggiungi\s+(\d+)?\s*(litri?|litro|pezzi?|pz|kg|grammi?|g)?\s*([a-z√†√®√©√¨√≤√π ]+?)\s+alla\s+lista(?:\s+del)?\s+(supermercato|online)/;
      // Pattern ‚ÄúTogli|Rimuovi [prodotto] dalla lista (supermercato|online)‚Äù
      const rimuoviPattern = /(togli|rimuovi)\s+([a-z√†√®√©√¨√≤√π ]+?)\s+dalla\s+lista(?:\s+del)?\s+(supermercato|online)/;

      let m;
      if ((m = aggiungiPattern.exec(text))) {
        // Estraggo quantit√† (opzionale) e unit√† (opzionale)
        const rawQty = m[1];
        const rawUn = m[2];
        let quantita = 1;
        let unita = "";

        if (rawQty) {
          quantita = parseInt(rawQty, 10);
        }
        if (rawUn) {
          unita = rawUn;
        }

        const prodotto = m[3].trim();
        const lista    = m[4];

        currentIntent = {
          type: "Aggiungi",
          prodotto: prodotto,
          quantita: quantita,
          unita: unita,
          lista: lista
        };
      }
      else if ((m = rimuoviPattern.exec(text))) {
        const prodotto = m[2].trim();
        const lista    = m[3];
        currentIntent = {
          type: "Rimuovi",
          prodotto: prodotto,
          lista: lista
        };
      }
      else {
        // Non ho riconosciuto alcun pattern valido
        speakText("Non ho capito. Puoi ripetere?");
        return;
      }

      // Se siamo arrivati qui, abbiamo un intent valido: chiediamo conferma
      askForConfirmation();
    }

    // Mostra banner di conferma
    function askForConfirmation() {
      if (!currentIntent) return;

      let msg = "";
      if (currentIntent.type === "Aggiungi") {
        msg = `Hai chiesto di aggiungere ${currentIntent.quantita} ${currentIntent.unita || ""} ${currentIntent.prodotto} alla lista ${currentIntent.lista}. Confermi?`;
      }
      else if (currentIntent.type === "Rimuovi") {
        msg = `Hai chiesto di rimuovere ${currentIntent.prodotto} dalla lista ${currentIntent.lista}. Confermi?`;
      }
      confirmMessage.innerText = msg;
      confirmBanner.style.display = "block";

      // Mantenere la lettura vocale del messaggio di conferma
      speakText(msg);
    }

    // Se l‚Äôutente clicca ‚ÄúS√¨‚Äù
    confirmYes.addEventListener('click', () => {
      confirmBanner.style.display = "none";
      executeIntent();
    });

    // Se l‚Äôutente clicca ‚ÄúNo‚Äù
    confirmNo.addEventListener('click', () => {
      confirmBanner.style.display = "none";
      speakText("Operazione annullata.");
      currentIntent = null;
    });

    // Esegue l‚Äôintent confermato (fittizio ‚Äì qui simulo le chiamate API)
    function executeIntent() {
      if (!currentIntent) return;

      if (currentIntent.type === "Aggiungi") {
        // Simulo una POST a /api/lista/aggiungi
        const payload = {
          userId: "UTENTE_DEMO",
          lista: currentIntent.lista,
          prodotti: [
            {
              nome: currentIntent.prodotto,
              quantita: currentIntent.quantita,
              unita: currentIntent.unita
            }
          ],
          timestamp: new Date().toISOString()
        };
        debugText.innerText = "üì° [Simulazione] Chiamata API /api/lista/aggiungi\n" + JSON.stringify(payload, null, 2);

        // Aggiorno localmente la lista ‚ÄúSupermercato‚Äù solo per demo
        if (currentIntent.lista === "supermercato") {
          addToLocalList(currentIntent.prodotto, currentIntent.quantita, currentIntent.unita);
          speakText(`Ho aggiunto ${currentIntent.quantita} ${currentIntent.unita || ""} ${currentIntent.prodotto} alla lista del supermercato.`);
        } else {
          speakText(`(Demo) Aggiungo ${currentIntent.prodotto} alla lista online.`);
        }
      }
      else if (currentIntent.type === "Rimuovi") {
        // Simulo una POST a /api/lista/rimuovi
        const payload = {
          userId: "UTENTE_DEMO",
          lista: currentIntent.lista,
          prodotto: currentIntent.prodotto,
          timestamp: new Date().toISOString()
        };
        debugText.innerText = "üì° [Simulazione] Chiamata API /api/lista/rimuovi\n" + JSON.stringify(payload, null, 2);

        // Rimuovo da lista locale se esiste
        if (currentIntent.lista === "supermercato") {
          removeFromLocalList(currentIntent.prodotto);
          speakText(`Ho rimosso ${currentIntent.prodotto} dalla lista del supermercato.`);
        } else {
          speakText(`(Demo) Rimuovo ${currentIntent.prodotto} dalla lista online.`);
        }
      }

      currentIntent = null;
    }

    // Funzione di sintesi vocale (Text-to-Speech)
    function speakText(text) {
      if (!window.speechSynthesis) return;
      const utter = new SpeechSynthesisUtterance(text);
      utter.lang = 'it-IT';
      window.speechSynthesis.speak(utter);
    }

    // Gestione lista ‚ÄúSupermercato‚Äù in locale (solo per demo)
    let localSuperList = []; // array di nomi di prodotto
    function renderLocalList() {
      listaSuper.innerHTML = "";
      if (localSuperList.length === 0) {
        listaSuper.innerHTML = "<li>(vuota)</li>";
        return;
      }
      localSuperList.forEach((item, idx) => {
        const li = document.createElement('li');
        li.innerText = item;
        const btn = document.createElement('button');
        btn.className = "remove-btn";
        btn.innerText = "‚ùå";
        btn.onclick = () => {
          localSuperList.splice(idx, 1);
          renderLocalList();
        };
        li.appendChild(btn);
        listaSuper.appendChild(li);
      });
    }
    function addToLocalList(nome, quantita, unita) {
      const label = quantita > 1
                    ? `${quantita} ${unita || ""} ${nome}`
                    : nome;
      localSuperList.push(label);
      renderLocalList();
    }
    function removeFromLocalList(nome) {
      // Rimuovo la prima occorrenza che contiene la stringa ‚Äúnome‚Äù
      const idx = localSuperList.findIndex(item => item.includes(nome));
      if (idx !== -1) {
        localSuperList.splice(idx, 1);
      }
      renderLocalList();
    }

  
      // Toast per aggiunta manuale preferiti

  if (addPrefBtn) {
    addPrefBtn.addEventListener('click', () => showToast('Prodotto aggiunto! ‚úÖ'));
      // Fallback: toast per qualunque pulsante ‚Äú+‚Äù
  document.addEventListener('click', function(e) {
    e.target.closest('[data-toast="add"]') {
      showToast('Prodotto aggiunto! \u2705');
   
        // Imposta automaticamente data-toast="add" su tutti i pulsanti con icona "+"
    document.querySelectorAll('button').forEach(btn => {
      const txt = btn.textContent.trim();
      if (txt === '+' || txt.includes('\u2795')) {
        btn.setAttribute('data-toast', 'add');
      }
    });
}
  });

  }
// All‚Äôavvio, mostro lista vuota
    renderLocalList();
  </script>
</body>
</html>
